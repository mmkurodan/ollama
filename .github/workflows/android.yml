name: Build native libs and APK

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-mbedtls:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y cmake git build-essential

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Build mbedTLS for arm64
        run: |
          set -e
          export API=24
          export HOST_TAG=linux-x86_64
          export TOOLCHAIN=$ANDROID_NDK/toolchains/llvm/prebuilt/$HOST_TAG

          git clone https://github.com/Mbed-TLS/mbedtls.git
          cd mbedtls
          git checkout v3.5.1

          mkdir build
          cd build

          cmake .. \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_SYSTEM_VERSION=$API \
            -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK \
            -DCMAKE_ANDROID_STL_TYPE=c++_static \
            -DCMAKE_C_COMPILER=$TOOLCHAIN/bin/aarch64-linux-android$API-clang \
            -DCMAKE_CXX_COMPILER=$TOOLCHAIN/bin/aarch64-linux-android$API-clang++ \
            -DENABLE_TESTING=OFF \
            -DENABLE_PROGRAMS=OFF \
            -DCMAKE_INSTALL_PREFIX=$PWD/install

          make -j"$(nproc)"
          make install

      - name: Upload mbedTLS artifact
        uses: actions/upload-artifact@v4
        with:
          name: mbedtls-arm64
          path: mbedtls/build/install

  build-libcurl:
    runs-on: ubuntu-latest
    needs: build-mbedtls
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y autoconf automake libtool pkg-config build-essential git

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Download mbedTLS artifact
        uses: actions/download-artifact@v4
        with:
          name: mbedtls-arm64
          path: mbedtls-arm64

      - name: Build libcurl for arm64 (mbedTLS)
        run: |
          set -e
          git clone https://github.com/curl/curl.git
          cd curl
          git checkout curl-8_5_0

          autoreconf -fi

          export API=24
          export HOST_TAG=linux-x86_64
          export TOOLCHAIN=$ANDROID_NDK/toolchains/llvm/prebuilt/$HOST_TAG
          export CC=$TOOLCHAIN/bin/aarch64-linux-android${API}-clang
          export CXX=$TOOLCHAIN/bin/aarch64-linux-android${API}-clang++
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib

          ./configure \
            --host=aarch64-linux-android \
            --with-mbedtls=$GITHUB_WORKSPACE/mbedtls-arm64 \
            --disable-shared \
            --enable-static \
            --without-zstd \
            --without-brotli \
            --prefix=$PWD/build/arm64

          make -j"$(nproc)"
          make install

      - name: Upload libcurl artifact
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-arm64
          path: curl/build/arm64

  build-apk:
    runs-on: ubuntu-latest
    needs: build-libcurl
    steps:
      - uses: actions/checkout@v4

      - name: "Debug: show workspace structure"
        run: |
          echo "=== WORKSPACE ==="
          ls -al $GITHUB_WORKSPACE
          echo "=== RECURSIVE ==="
          ls -R $GITHUB_WORKSPACE

      - name: Download mbedTLS artifact
        uses: actions/download-artifact@v4
        with:
          name: mbedtls-arm64
          path: app/src/main/cpp/third_party/mbedtls

      - name: Download libcurl artifact
        uses: actions/download-artifact@v4
        with:
          name: libcurl-arm64
          path: app/src/main/cpp/third_party/libcurl

      - name: Build debug APK
        run: |
          cd $GITHUB_WORKSPACE/app
          chmod +x gradlew
          ./gradlew assembleDebug
